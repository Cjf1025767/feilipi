/* MyPhoner for Genesys SDK version 0.1 */(function(){'use strict';(function(e,n){"object"==typeof exports?module.exports=n():"function"==typeof define&&define.amd?define([],n):(e.org=e.org||{},e.org.cometd=n())})(window,function(){var e=Math.floor;function n(){var n={};self.onmessage=function(t){var e=t.data,a=n[e.id];switch(e.type){case"setTimeout":n[e.id]=self.setTimeout(function(){delete n[e.id],self.postMessage({id:e.id})},e.delay);break;case"clearTimeout":delete n[e.id],a&&self.clearTimeout(a);break;default:throw"Unknown command "+e.type;}}}var t=function(){var e=0,n={};this.register=function(t){var a=++e;return n[a]=t,a},this.unregister=function(e){var t=n[e];return delete n[e],t},this.setTimeout=function(e,n){return window.setTimeout(e,n)},this.clearTimeout=function(e){window.clearTimeout(e)}},a={isString:function(e){return void 0!==e&&null!==e&&("string"==typeof e||e instanceof String)},isArray:function(e){return void 0!==e&&null!==e&&e instanceof Array},inArray:function(e,n){for(var t=0;t<n.length;++t)if(e===n[t])return t;return-1}},s=function(){var e=[],n={};this.getTransportTypes=function(){return e.slice(0)},this.findTransportTypes=function(t,a,s){for(var r,o=[],d=0;d<e.length;++d)r=e[d],!0===n[r].accept(t,a,s)&&o.push(r);return o},this.negotiateTransport=function(t,a,s,r){for(var o,d=0;d<e.length;++d){o=e[d];for(var u=0;u<t.length;++u)if(o===t[u]){var c=n[o];if(!0===c.accept(a,s,r))return c}}return null},this.add=function(t,a,s){for(var r=!1,o=0;o<e.length;++o)if(e[o]===t){r=!0;break}return r||("number"==typeof s?e.splice(s,0,t):e.push(t),n[t]=a),!r},this.find=function(t){for(var a=0;a<e.length;++a)if(e[a]===t)return n[t];return null},this.remove=function(t){for(var a=0;a<e.length;++a)if(e[a]===t){e.splice(a,1);var s=n[t];return delete n[t],s}return null},this.clear=function(){e=[],n={}},this.reset=function(t){for(var a=0;a<e.length;++a)n[e[a]].reset(t)}},i=function(){var e,n,t;this.registered=function(t,a){e=t,n=a},this.unregistered=function(){e=null,n=null},this._notifyTransportTimeout=function(e){var t=n._getTransportListeners("timeout");if(t)for(var a,s=0;s<t.length;++s){a=t[s];try{var r=a.call(this,e);if("number"==typeof r&&0<r)return r}catch(e){this._info("Exception during execution of transport listener",a,e)}}return 0},this._debug=function(){n._debug.apply(n,arguments)},this._info=function(){n._info.apply(n,arguments)},this._mixin=function(){return n._mixin.apply(n,arguments)},this.getConfiguration=function(){return n.getConfiguration()},this.getAdvice=function(){return n.getAdvice()},this.setTimeout=function(e,t){return n.setTimeout(e,t)},this.clearTimeout=function(e){n.clearTimeout(e)},this.convertToJSON=function(e){for(var n=this.getConfiguration().maxSendBayeuxMessageSize,t="[",a=0;a<e.length;++a){0<a&&(t+=",");var s=e[a],r=JSON.stringify(s);if(r.length>n)throw"maxSendBayeuxMessageSize "+n+" exceeded";t+=r}return t+="]",t},this.convertToMessages=function(e){if(a.isString(e))try{return JSON.parse(e)}catch(n){throw this._debug("Could not convert to JSON the following string","\""+e+"\""),n}if(a.isArray(e))return e;if(void 0===e||null===e)return[];if(e instanceof Object)return[e];throw"Conversion Error "+e+", typeof "+typeof e},this.accept=function(){throw"Abstract"},this.getType=function(){return e},this.getURL=function(){return t},this.setURL=function(e){t=e},this.send=function(){throw"Abstract"},this.reset=function(n){this._debug("Transport",e,"reset",n?"initial":"retry")},this.abort=function(){this._debug("Transport",e,"aborted")},this.toString=function(){return this.getType()}};i.derive=function(e){function n(){}return n.prototype=e,new n};var r=function(){function e(e){for(;0<m.length;){var n=m[0],t=n[0],a=n[1];if(t.url===e.url&&t.sync===e.sync){m.shift(),e.messages=e.messages.concat(t.messages),this._debug("Coalesced",t.messages.length,"messages from request",a.id);continue}break}}function n(e,t,a){var s=this._notifyTransportTimeout(e.messages);if(0<s){this._debug("Transport",this.getType(),"extended waiting for message replies of request",t.id,":",s,"ms");var i=this;t.timeout=this.setTimeout(function(){n.call(i,e,t,a+s)},s)}else{t.expired=!0;var r="Transport "+this.getType()+" expired waiting for message replies of request "+t.id+": "+a+" ms",o={reason:r},d=t.xhr;o.httpCode=this.xhrStatus(d),this.abortXHR(d),this._debug(r),this.complete(t,!1,t.metaConnect),e.onFailure(d,e.messages,o)}}function t(e,t){if(this.transportSend(e,t)&&(t.expired=!1,!e.sync)){var a=this.getConfiguration().maxNetworkDelay;!0===t.metaConnect&&(a+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"started waiting for message replies of request",t.id,":",a,"ms");var s=this;t.timeout=this.setTimeout(function(){n.call(s,e,t,a)},a)}}function s(e){var n=++l,a={id:n,metaConnect:!1,envelope:e};p.length<this.getConfiguration().maxConnections-1?(p.push(a),t.call(this,e,a)):(this._debug("Transport",this.getType(),"queueing request",n,"envelope",e),m.push([e,a]))}function r(e){var n=e.id;if(this._debug("Transport",this.getType(),"/meta/connect complete, request",n),null!==g&&g.id!==n)throw"/meta/connect request mismatch, completing request "+n;g=null}function o(n,t){var i=a.inArray(n,p);if(0<=i&&p.splice(i,1),0<m.length){var r=m.shift(),o=r[0],d=r[1];if(this._debug("Transport dequeued request",d.id),t)this.getConfiguration().autoBatch&&e.call(this,o),s.call(this,o),this._debug("Transport completed request",n.id,o);else{var u=this;this.setTimeout(function(){u.complete(d,!1,d.metaConnect);var e={reason:"Previous request failed"},n=d.xhr;e.httpCode=u.xhrStatus(n),o.onFailure(n,o.messages,e)},0)}}}function d(e){if(null!==g)throw"Concurrent /meta/connect requests not allowed, request id="+g.id+" not yet completed";var n=++l;this._debug("Transport",this.getType(),"/meta/connect send, request",n,"envelope",e);var a={id:n,metaConnect:!0,envelope:e};t.call(this,e,a),g=a}var u=new i,c=i.derive(u),l=0,g=null,p=[],m=[];return c.complete=function(e,n,t){t?r.call(this,e):o.call(this,e,n)},c.transportSend=function(){throw"Abstract"},c.transportSuccess=function(e,n,t){n.expired||(this.clearTimeout(n.timeout),this._debug("Transport",this.getType(),"cancelled waiting for message replies"),this.complete(n,!0,n.metaConnect),t&&0<t.length?e.onSuccess(t):e.onFailure(n.xhr,e.messages,{httpCode:204}))},c.transportFailure=function(e,n,t){n.expired||(this.clearTimeout(n.timeout),this._debug("Transport",this.getType(),"cancelled waiting for failed message replies"),this.complete(n,!1,n.metaConnect),e.onFailure(n.xhr,e.messages,t))},c.send=function(e,n){n?d.call(this,e):s.call(this,e)},c.abort=function(){u.abort();for(var e,n=0;n<p.length;++n)e=p[n],e&&(this._debug("Aborting request",e),!this.abortXHR(e.xhr)&&this.transportFailure(e.envelope,e,{reason:"abort"}));var t=g;t&&(this._debug("Aborting /meta/connect request",t),!this.abortXHR(t.xhr)&&this.transportFailure(t.envelope,t,{reason:"abort"})),this.reset(!0)},c.reset=function(e){u.reset(e),g=null,p=[],m=[]},c.abortXHR=function(e){if(e)try{var n=e.readyState;return e.abort(),n!==window.XMLHttpRequest.UNSENT}catch(e){this._debug(e)}return!1},c.xhrStatus=function(e){if(e)try{return e.status}catch(e){this._debug(e)}return-1},c},o=function(){function e(e){try{e.context=t.context}catch(n){this._debug("Could not copy transport context into XHR",n)}}var n=new r,t=i.derive(n),a=!0;return t.accept=function(e,n){return a||!n},t.newXMLHttpRequest=function(){return new window.XMLHttpRequest},t.xhrSend=function(n){var a=t.newXMLHttpRequest();e(a),a.withCredentials=!0,a.open("POST",n.url,!0!==n.sync);var s=n.headers;if(s)for(var i in s)s.hasOwnProperty(i)&&a.setRequestHeader(i,s[i]);return a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.onload=function(){200===a.status?n.onSuccess(a.responseText):n.onError(a.statusText)},a.onabort=a.onerror=function(){n.onError(a.statusText)},a.send(n.body),a},t.transportSend=function(e,n){this._debug("Transport",this.getType(),"sending request",n.id,"envelope",e);var t=this;try{var s=!0;return n.xhr=this.xhrSend({transport:this,url:e.url,sync:e.sync,headers:this.getConfiguration().requestHeaders,body:this.convertToJSON(e.messages),onSuccess:function(s){t._debug("Transport",t.getType(),"received response",s);var i=!1;try{var r=t.convertToMessages(s);0===r.length?(a=!1,t.transportFailure(e,n,{httpCode:204})):(i=!0,t.transportSuccess(e,n,r))}catch(s){if(t._debug(s),!i){a=!1;var o={exception:s};o.httpCode=t.xhrStatus(n.xhr),t.transportFailure(e,n,o)}}},onError:function(i,r){t._debug("Transport",t.getType(),"received error",i,r),a=!1;var o={reason:i,exception:r};o.httpCode=t.xhrStatus(n.xhr),s?t.setTimeout(function(){t.transportFailure(e,n,o)},0):t.transportFailure(e,n,o)}}),s=!1,!0}catch(s){return this._debug("Transport",this.getType(),"exception:",s),a=!1,this.setTimeout(function(){t.transportFailure(e,n,{exception:s})},0),!1}},t.reset=function(e){n.reset(e),a=!0},t},d=function(){function e(e,n,t){var a=this;return function(){a.transportFailure(e,n,"error",t)}}var n=new r,t=i.derive(n),a=0;return t.accept=function(){return!0},t.jsonpSend=function(n){var t=document.getElementsByTagName("head")[0],s=document.createElement("script"),i="_cometd_jsonp_"+a++;window[i]=function(e){t.removeChild(s),delete window[i],n.onSuccess(e)};var r=n.url;r+=0>r.indexOf("?")?"?":"&",r+="jsonp="+i,r+="&message="+encodeURIComponent(n.body),s.src=r,s.async=!0!==n.sync,s.type="application/javascript",s.onerror=function(t){n.onError("jsonp "+t.type)},t.appendChild(s)},t.transportSend=function(n,t){for(var a=this,s=0,r=n.messages.length,o=[];0<r;){var d=JSON.stringify(n.messages.slice(s,s+r)),u=n.url.length+encodeURI(d).length,c=this.getConfiguration().maxURILength;if(u>c){if(1===r){var l="Bayeux message too big ("+u+" bytes, max is "+c+") for transport "+this.getType();return void this.setTimeout(e.call(this,n,t,l),0)}--r;continue}o.push(r),s+=r,r=n.messages.length-s}var g=n;if(1<o.length){var p=0,m=o[0];this._debug("Transport",this.getType(),"split",n.messages.length,"messages into",o.join(" + ")),g=this._mixin(!1,{},n),g.messages=n.messages.slice(p,m),g.onSuccess=n.onSuccess,g.onFailure=n.onFailure;for(var f,h=1;h<o.length;++h)f=this._mixin(!1,{},n),p=m,m+=o[h],f.messages=n.messages.slice(p,m),f.onSuccess=n.onSuccess,f.onFailure=n.onFailure,this.send(f,t.metaConnect)}this._debug("Transport",this.getType(),"sending request",t.id,"envelope",g);try{var b=!0;return this.jsonpSend({transport:this,url:g.url,sync:g.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(g.messages),onSuccess:function(e){var n=!1;try{var s=a.convertToMessages(e);0===s.length?a.transportFailure(g,t,{httpCode:204}):(n=!0,a.transportSuccess(g,t,s))}catch(e){a._debug(e),n||a.transportFailure(g,t,{exception:e})}},onError:function(e,n){var s={reason:e,exception:n};b?a.setTimeout(function(){a.transportFailure(g,t,s)},0):a.transportFailure(g,t,s)}}),b=!1,!0}catch(e){return this.setTimeout(function(){a.transportFailure(g,t,{exception:e})},0),!1}},t},u=function(){function e(e,n){e&&(this.webSocketClose(e,n.code,n.reason),this.onClose(e,n))}function n(e){return e===b||e===h}function t(e,n,t){for(var a,s=[],r=0;r<n.messages.length;++r)a=n.messages[r],a.id&&s.push(a.id);e.envelopes[s.join(",")]=[n,t],this._debug("Transport",this.getType(),"stored envelope, envelopes",e.envelopes)}function s(e,n){for(var t,s=!1,i=e.envelopes,r=0;r<n.length;++r)for(var o in t=n[r],i)if(i.hasOwnProperty(o)){var d=o.split(","),u=a.inArray(t,d);if(0<=u){s=!0,d.splice(u,1);var c=i[o][0],l=i[o][1];delete i[o],0<d.length&&(i[d.join(",")]=[c,l]);break}}s&&this._debug("Transport",this.getType(),"removed envelope, envelopes",i)}function r(t){if(!b){var a=c.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",a);try{var s=c.getConfiguration().protocol;t.webSocket=s?new window.WebSocket(a,s):new window.WebSocket(a),b=t}catch(e){throw p=!1,this._debug("Exception while creating WebSocket object",e),e}f=!1!==c.getConfiguration().stickyReconnect;var i=this,r=c.getConfiguration().connectTimeout;0<r&&(t.connectTimer=this.setTimeout(function(){c._debug("Transport",i.getType(),"timed out while connecting to URL",a,":",r,"ms"),e.call(i,t,{code:1e3,reason:"Connect Timeout"})},r));var o=function(){c._debug("WebSocket onopen",t),t.connectTimer&&i.clearTimeout(t.connectTimer),n(t)?(b=null,h=t,m=!0,i.onOpen(t)):(c._warn("Closing extra WebSocket connection",this,"active connection",h),e.call(i,t,{code:1e3,reason:"Extra Connection"}))},d=function(e){e=e||{code:1e3},c._debug("WebSocket onclose",t,e,"connecting",b,"current",h),t.connectTimer&&i.clearTimeout(t.connectTimer),i.onClose(t,e)},u=function(e){c._debug("WebSocket onmessage",e,t),i.onMessage(t,e)};t.webSocket.onopen=o,t.webSocket.onclose=d,t.webSocket.onerror=function(){d({code:1e3,reason:"Error"})},t.webSocket.onmessage=u,this._debug("Transport",this.getType(),"configured callbacks on",t)}}function o(n,t,a){var s=this._notifyTransportTimeout([t]);if(0<s){this._debug("Transport",this.getType(),"extended waiting for message replies:",s,"ms");var i=this;n.timeouts[t.id]=this.setTimeout(function(){o.call(i,n,t,a+s)},s)}else this._debug("Transport",this.getType(),"expired waiting for message reply",t.id,":",a,"ms"),e.call(this,n,{code:1e3,reason:"Message Timeout"})}function d(e,n,t){var a=this;try{var r=this.convertToJSON(n.messages)}catch(t){this._debug("Transport",this.getType(),"exception:",t);for(var d,u=[],c=0;c<n.messages.length;++c)d=n.messages[c],u.push(d.id);return s.call(this,e,u),void this.setTimeout(function(){a._notifyFailure(n.onFailure,e,n.messages,{exception:t})},0)}e.webSocket.send(r),this._debug("Transport",this.getType(),"sent",n,"/meta/connect =",t);var l=this.getConfiguration().maxNetworkDelay;t&&(l+=this.getAdvice().timeout,T=!0);for(var g=[],p=0;p<n.messages.length;++p)(function(){var t=n.messages[p];t.id&&(g.push(t.id),e.timeouts[t.id]=a.setTimeout(function(){o.call(a,e,t,l)},l))})();this._debug("Transport",this.getType(),"started waiting for message replies",l,"ms, messageIds:",g,", timeouts:",e.timeouts)}function u(n,a,s){try{null===n?(n=b||{envelopes:{},timeouts:{}},t.call(this,n,a,s),r.call(this,n)):(t.call(this,n,a,s),d.call(this,n,a,s))}catch(t){var i=this;this.setTimeout(function(){e.call(i,n,{code:1e3,reason:"Exception",exception:t})},0)}}var c,l=new i,g=i.derive(l),p=!0,m=!1,f=!0,h=null,b=null,T=!1,y=null;return g.reset=function(e){l.reset(e),p=!0,e&&(m=!1),f=!0,e&&(h=null),b=null,T=!1},g._notifySuccess=function(e,n){e.call(this,n)},g._notifyFailure=function(e,n,t,a){e.call(this,n,t,a)},g.onOpen=function(e){var n=e.envelopes;for(var t in this._debug("Transport",this.getType(),"opened",e,"pending messages",n),n)if(n.hasOwnProperty(t)){var a=n[t],s=a[0],i=a[1];y=s.onSuccess,d.call(this,e,s,i)}},g.onMessage=function(e,n){this._debug("Transport",this.getType(),"received websocket message",n,e);for(var t,a=!1,r=this.convertToMessages(n.data),o=[],d=0;d<r.length;++d){if(t=r[d],(/^\/meta\//.test(t.channel)||void 0===t.data)&&t.id){o.push(t.id);var u=e.timeouts[t.id];u&&(this.clearTimeout(u),delete e.timeouts[t.id],this._debug("Transport",this.getType(),"removed timeout for message",t.id,", timeouts",e.timeouts))}"/meta/connect"===t.channel&&(T=!1),"/meta/disconnect"!==t.channel||T||(a=!0)}s.call(this,e,o),this._notifySuccess(y,r),a&&this.webSocketClose(e,1e3,"Disconnect")},g.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t),n(e)&&(p=f&&m,b=null,h=null);var a=e.timeouts;for(var s in e.timeouts={},a)a.hasOwnProperty(s)&&this.clearTimeout(a[s]);var i=e.envelopes;for(var r in e.envelopes={},i)if(i.hasOwnProperty(r)){var o=i[r][0],d=i[r][1];d&&(T=!1);var u={websocketCode:t.code,reason:t.reason};t.exception&&(u.exception=t.exception),this._notifyFailure(o.onFailure,e,o.messages,u)}},g.registered=function(e,n){l.registered(e,n),c=n},g.accept=function(){return this._debug("Transport",this.getType(),"accept, supported:",p),p&&!!window.WebSocket&&!1!==c.websocketEnabled},g.send=function(e,n){this._debug("Transport",this.getType(),"sending",e,"/meta/connect =",n),u.call(this,h,e,n)},g.webSocketClose=function(e,n,t){try{e.webSocket&&e.webSocket.close(n,t)}catch(e){this._debug(e)}},g.abort=function(){l.abort(),e.call(this,h,{code:1e3,reason:"Abort"}),this.reset(!0)},g},c=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],l=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];return{CometD:function(e){function i(e,n){try{return e[n]}catch(e){}}function r(e){return a.isString(e)}function c(e){return!!("A"<=e&&"Z">=e)||"a"<=e&&"z">=e}function l(e){return"0"<=e&&"9">=e}function g(e){return!(" "!==e&&"!"!==e&&"#"!==e&&"$"!==e&&"("!==e&&")"!==e&&"*"!==e&&"+"!==e&&"-"!==e&&"."!==e&&"/"!==e&&"@"!==e&&"_"!==e&&"{"!==e&&"~"!==e&&"}"!==e)}function p(e){if(!r(e))return!1;if(2>e.length)return!1;if("/"!==e.charAt(0))return!1;for(var n,t=1;t<e.length;++t)if(n=e.charAt(t),!(c(n)||l(n)||g(n)))return!1;return!0}function m(e){return void 0!==e&&null!==e&&"function"==typeof e}function f(e,n){for(var t=Math.pow,a="";0<--n&&!(e>=t(10,n));)a+="0";return a+=e,a}function h(e,n){if(window.console){var t=window.console[e];if(m(t)){var a=new Date;[].splice.call(n,0,0,f(a.getHours(),2)+":"+f(a.getMinutes(),2)+":"+f(a.getSeconds(),2)+"."+f(a.getMilliseconds(),3)),t.apply(window.console,n)}}}function b(e){return /(^https?:\/\/)?(((\[[^\]]+])|([^:/?#]+))(:(\d+))?)?([^?#]*)(.*)?/.exec(e)}function T(e){Ce._debug("Configuring cometd object with",e),r(e)&&(e={url:e}),e||(e={}),Je=Ce._mixin(!1,Je,e);var t=Ce.getURL();if(!t)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var a=b(t),s=a[2],i=a[8],o=a[9];if(Se=Ce._isCrossDomain(s),Je.appendMessageTypeToURL)if(void 0!==o&&0<o.length)Ce._info("Appending message type to URI "+i+o+" is not supported, disabling 'appendMessageTypeToURL' configuration"),Je.appendMessageTypeToURL=!1;else{var d=i.split("/"),u=d.length-1;i.match(/\/$/)&&(u-=1),0<=d[u].indexOf(".")&&(Ce._info("Appending message type to URI "+i+" is not supported, disabling 'appendMessageTypeToURL' configuration"),Je.appendMessageTypeToURL=!1)}if(window.Worker&&window.Blob&&window.URL&&Je.useWorkerScheduler){var c=n.toString();c=c.substring(c.indexOf("{")+1,c.lastIndexOf("}"));var l=new window.Blob([c],{type:"application/json"}),g=window.URL.createObjectURL(l),p=new window.Worker(g);_e.setTimeout=function(e,n){var t=_e.register(e);return p.postMessage({id:t,type:"setTimeout",delay:n}),t},_e.clearTimeout=function(e){_e.unregister(e),p.postMessage({id:e,type:"clearTimeout"})},p.onmessage=function(n){var e=n.data.id,t=_e.unregister(e);t&&t()}}}function y(e){if(e){var n=Ee[e.channel];n&&n[e.id]&&(delete n[e.id],Ce._debug("Removed",e.listener?"listener":"subscription",e))}}function k(e){e&&!e.listener&&y(e)}function x(){for(var e in Ee)if(Ee.hasOwnProperty(e)){var n=Ee[e];if(n)for(var t in n)n.hasOwnProperty(t)&&k(n[t])}}function v(e){De!==e&&(Ce._debug("Status",De,"->",e),De=e)}function _(){return"disconnecting"===De||"disconnected"===De}function C(){var e=++Ue;return""+e}function S(e,n,t,a,s){try{return n.call(e,a)}catch(e){var i=Ce.onExtensionException;if(m(i)){Ce._debug("Invoking extension exception handler",t,e);try{i.call(Ce,e,t,s,a)}catch(e){Ce._info("Exception during execution of extension exception handler",t,e)}}else Ce._info("Exception during execution of extension",t,e);return a}}function R(e){for(var n=0;n<Fe.length&&!(e===void 0||null===e);++n){var t=Fe[n],a=t.extension.incoming;if(m(a)){var s=S(t.extension,a,t.name,e,!1);e=s===void 0?e:s}}return e}function D(e){for(var n=Fe.length-1;0<=n&&!(e===void 0||null===e);--n){var t=Fe[n],a=t.extension.outgoing;if(m(a)){var s=S(t.extension,a,t.name,e,!0);e=s===void 0?e:s}}return e}function U(e,n){var t=Ee[e];if(t)for(var a in t)if(t.hasOwnProperty(a)){var s=t[a];if(s)try{s.callback.call(s.scope,n)}catch(e){var i=Ce.onListenerException;if(m(i)){Ce._debug("Invoking listener exception handler",s,e);try{i.call(Ce,e,s,s.listener,n)}catch(e){Ce._info("Exception during execution of listener exception handler",s,e)}}else Ce._info("Exception during execution of listener",s,n,e)}}}function w(e,n){U(e,n);for(var t,a=e.split("/"),s=a.length-1,r=s;0<r;--r)t=a.slice(0,r).join("/")+"/*",r===s&&U(t,n),t+="*",U(t,n)}function L(){null!==qe&&Ce.clearTimeout(qe),qe=null}function I(e,n){L();var t=He.interval+n;Ce._debug("Function scheduled in",t,"ms, interval =",He.interval,"backoff =",Me,e),qe=Ce.setTimeout(e,t)}function N(e,n,t){for(var a=0;a<e.length;++a){var s=e[a],r=s.id;we&&(s.clientId=we),s=D(s),s!==void 0&&null!==s?(s.id=r,e[a]=s):(delete Oe[r],e.splice(a--,1))}if(0!==e.length){n&&(ze=e[0]);var o=Ce.getURL();Je.appendMessageTypeToURL&&(!o.match(/\/$/)&&(o+="/"),t&&(o+=t));var d={url:o,sync:!1,messages:e,onSuccess:function(e){try{Ze.call(Ce,e)}catch(e){Ce._info("Exception during handling of messages",e)}},onFailure:function(e,n,t){try{var a=Ce.getTransport();t.connectionType=a?a.getType():"unknown",Ke.call(Ce,e,n,t)}catch(e){Ce._info("Exception during handling of failure",e)}}};Ce._debug("Send",d),ke.send(d,n)}}function j(e){0<Le||!0===Ne?Ie.push(e):N([e],!1)}function E(){Me=0}function A(){return Me<Je.maxBackoff&&(Me+=Je.backoffIncrement),Me}function M(){++Le,Ce._debug("Starting batch, depth",Le)}function q(){var e=Ie;Ie=[],0<e.length&&N(e,!1)}function F(){if(--Le,Ce._debug("Ending batch, depth",Le),0>Le)throw"Calls to startBatch() and endBatch() are not paired";0!==Le||_()||Ne||q()}function H(){if(!_()){var e={id:C(),channel:"/meta/connect",connectionType:ke.getType()};We||(e.advice={timeout:0}),v("connecting"),Ce._debug("Connect sent",e),N([e],!0,"connect"),v("connected")}}function O(e){v("connecting"),I(function(){H()},e)}function B(e){e&&(He=Ce._mixin(!1,{},Je.advice,e),Ce._debug("New advice",He))}function P(e){if(L(),e&&ke&&ke.abort(),Se=!1,ke=null,v("disconnected"),we=null,Le=0,E(),Pe=!1,We=!1,Xe=0,ze=null,0<Ie.length){var n=Ie;Ie=[],Ke.call(Ce,void 0,n,{reason:"Disconnected"})}}function W(e,n,t){var a=Ce.onTransportException;if(m(a)){Ce._debug("Invoking transport exception handler",e,n,t);try{a.call(Ce,t,e,n)}catch(e){Ce._info("Exception during execution of transport exception handler",e)}}}function X(e,n){m(e)&&(n=e,e=void 0),we=null,x(),_()&&Re.reset(!0),B({}),Le=0,Ne=!0,xe=e,ve=n;var t=Ce.getURL(),a=Re.findTransportTypes("1.0",Se,t),s={id:C(),version:"1.0",minimumVersion:"1.0",channel:"/meta/handshake",supportedConnectionTypes:a,advice:{timeout:He.timeout,interval:He.interval}},i=Ce._mixin(!1,{},xe,s);if(Ce._putCallback(i.id,n),!ke&&(ke=Re.negotiateTransport(a,"1.0",Se,t),!ke)){var r="Could not find initial transport among: "+Re.getTransportTypes();throw Ce._warn(r),r}Ce._debug("Initial transport is",ke.getType()),v("handshaking"),Ce._debug("Handshake sent",i),N([i],!1,"handshake")}function G(e){v("handshaking"),Ne=!0,I(function(){X(xe,ve)},e)}function z(e,n){try{e.call(Ce,n)}catch(e){var t=Ce.onCallbackException;if(m(t)){Ce._debug("Invoking callback exception handler",e);try{t.call(Ce,e,n)}catch(e){Ce._info("Exception during execution of callback exception handler",e)}}else Ce._info("Exception during execution of message callback",e)}}function J(e){var n=Ce._getCallback([e.id]);m(n)&&(delete Oe[e.id],z(n,e))}function Z(e){var n=Be[e.id];if(delete Be[e.id],n){Ce._debug("Handling remote call response for",e,"with context",n);var t=n.timeout;t&&Ce.clearTimeout(t);var a=n.callback;if(m(a))return z(a,e),!0}return!1}function K(e){Ce._debug("Transport failure handling",e),e.transport&&(ke=e.transport),e.url&&ke.setURL(e.url);var n=e.action,t=e.delay||0;switch(n){case"handshake":G(t);break;case"retry":O(t);break;case"none":P(!0);break;default:throw"Unknown action "+n;}}function V(e,n){J(e),w("/meta/handshake",e),w("/meta/unsuccessful",e),_()&&(n.action="none"),Ce.onTransportFailure.call(Ce,e,n,K)}function Y(e){var n=Ce.getURL();if(e.successful){var t=Ce._isCrossDomain(b(n)[2]),a=Re.negotiateTransport(e.supportedConnectionTypes,e.version,t,n);if(null===a)return e.successful=!1,void V(e,{cause:"negotiation",action:"none",transport:null});ke!==a&&(Ce._debug("Transport",ke.getType(),"->",a.getType()),ke=a);we=e.clientId,Ne=!1,q(),e.reestablish=Pe,Pe=!0,J(e),w("/meta/handshake",e),Ge=e["x-messages"]||0;var s=_()?"none":He.reconnect||"retry";switch(s){case"retry":E(),0===Ge?O(0):Ce._debug("Processing",Ge,"handshake-delivered messages");break;case"none":P(!0);break;default:throw"Unrecognized advice action "+s;}}else V(e,{cause:"unsuccessful",action:He.reconnect||"handshake",transport:ke})}function Q(e){V(e,{cause:"failure",action:"handshake",transport:null})}function ee(e){return!("disconnected"!==De)||!!(ze&&ze.id===e.id)&&(ze=null,!0)}function ne(e,n){w("/meta/connect",e),w("/meta/unsuccessful",e),_()&&(n.action="none"),Ce.onTransportFailure.call(Ce,e,n,K)}function te(e){if(!ee(e))Ce._debug("Mismatched /meta/connect reply",e);else if(We=e.successful,We){w("/meta/connect",e);var n=_()?"none":He.reconnect||"retry";switch(n){case"retry":E(),O(Me);break;case"none":P(!1);break;default:throw"Unrecognized advice action "+n;}}else ne(e,{cause:"unsuccessful",action:He.reconnect||"retry",transport:ke})}function ae(e){ee(e)?(We=!1,ne(e,{cause:"failure",action:"retry",transport:null})):Ce._debug("Mismatched /meta/connect failure",e)}function se(e){P(!0),J(e),w("/meta/disconnect",e),w("/meta/unsuccessful",e)}function ie(e){e.successful?(P(!1),J(e),w("/meta/disconnect",e)):se(e)}function re(e){se(e)}function oe(e){var n=Ee[e.subscription];if(n)for(var t in n)if(n.hasOwnProperty(t)){var a=n[t];a&&!a.listener&&(delete n[t],Ce._debug("Removed failed subscription",a))}J(e),w("/meta/subscribe",e),w("/meta/unsuccessful",e)}function de(e){e.successful?(J(e),w("/meta/subscribe",e)):oe(e)}function ue(e){oe(e)}function ce(e){J(e),w("/meta/unsubscribe",e),w("/meta/unsuccessful",e)}function le(e){e.successful?(J(e),w("/meta/unsubscribe",e)):ce(e)}function ge(e){ce(e)}function pe(e){Z(e)||(J(e),w("/meta/publish",e),w("/meta/unsuccessful",e))}function me(e){e.data===void 0?e.successful===void 0?Ce._warn("Unknown Bayeux Message",e):e.successful?(J(e),w("/meta/publish",e)):pe(e):!Z(e)&&(w(e.channel,e),0<Ge&&(--Ge,0===Ge&&(Ce._debug("Processed last handshake-delivered message"),O(0))))}function fe(e){pe(e)}function he(e){if(Xe=0,e=R(e),void 0!==e&&null!==e){B(e.advice);var n=e.channel;"/meta/handshake"===n?Y(e):"/meta/connect"===n?te(e):"/meta/disconnect"===n?ie(e):"/meta/subscribe"===n?de(e):"/meta/unsubscribe"===n?le(e):me(e)}}function be(e){var n=Ee[e];if(n)for(var t in n)if(n.hasOwnProperty(t)&&n[t])return!0;return!1}function Te(e,n){var t={scope:e,method:n};if(m(e))t.scope=void 0,t.method=e;else if(r(n)){if(!e)throw"Invalid scope "+e;if(t.method=e[n],!m(t.method))throw"Invalid callback "+n+" for scope "+e}else if(!m(n))throw"Invalid callback "+n;return t}function ye(e,n,t,a){var s=Te(n,t);Ce._debug("Adding",a?"listener":"subscription","on",e,"with scope",s.scope,"and callback",s.method);var i=++je,r={id:i,channel:e,scope:s.scope,callback:s.method,listener:a},o=Ee[e];return o||(o={},Ee[e]=o),o[i]=r,Ce._debug("Added",a?"listener":"subscription",r),r}var ke,xe,ve,_e=new t,Ce=this,Se=!1,Re=new s,De="disconnected",Ue=0,we=null,Le=0,Ie=[],Ne=!1,je=0,Ee={},Ae={},Me=0,qe=null,Fe=[],He={},Oe={},Be={},Pe=!1,We=!1,Xe=0,Ge=0,ze=null,Je={useWorkerScheduler:!0,protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,maxSendBayeuxMessageSize:8192,advice:{timeout:6e4,interval:0,reconnect:void 0,maxInterval:0}};this._mixin=function(e,n){for(var t,a=n||{},s=2;s<arguments.length;++s)if(t=arguments[s],void 0!==t&&null!==t)for(var r in t)if(t.hasOwnProperty(r)){var o=i(t,r),d=i(a,r);if(o===n)continue;if(void 0===o)continue;if(!(e&&"object"==typeof o&&null!==o))a[r]=o;else if(o instanceof Array)a[r]=this._mixin(e,d instanceof Array?d:[],o);else{var u="object"!=typeof d||d instanceof Array?{}:d;a[r]=this._mixin(e,u,o)}}return a},this._warn=function(){h("warn",arguments)},this._info=function(){"warn"!==Je.logLevel&&h("info",arguments)},this._debug=function(){"debug"===Je.logLevel&&h("debug",arguments)},this._isCrossDomain=function(e){return!!(window.location&&window.location.host&&e)&&e!==window.location.host};var Ze,Ke;this.send=j,this._getCallback=function(e){return Oe[e]},this._putCallback=function(e,n){var t=this._getCallback(e);return m(n)&&(Oe[e]=n),t},this.onTransportFailure=function(e,n,t){this._debug("Transport failure",n,"for",e);var a=this.getTransportRegistry(),s=this.getURL(),i=this._isCrossDomain(b(s)[2]),r="1.0",o=a.findTransportTypes(r,i,s);if("none"===n.action){if("/meta/handshake"===e.channel&&!n.transport){var d="Could not negotiate transport, client=["+o+"], server=["+e.supportedConnectionTypes+"]";this._warn(d),W(ke.getType(),null,{reason:d,connectionType:ke.getType(),transport:ke})}}else if(n.delay=this.getBackoffPeriod(),"/meta/handshake"===e.channel){if(!n.transport){var u=ke?ke.getType():null,c=a.negotiateTransport(o,r,i,s);if(!c)this._warn("Could not negotiate transport, client=["+o+"]"),W(u,null,e.failure),n.action="none";else{var l=c.getType();this._debug("Transport",u,"->",l),W(u,l,e.failure),n.action="handshake",n.transport=c}}"none"!==n.action&&this.increaseBackoffPeriod()}else{var g=new Date().getTime();if(0===Xe&&(Xe=g),"retry"===n.action){n.delay=this.increaseBackoffPeriod();var p=He.maxInterval;if(0<p){var m=He.timeout+He.interval+p,f=g-Xe;f+Me>m&&(n.action="handshake")}}"handshake"===n.action&&(n.delay=0,a.reset(!1),this.resetBackoffPeriod())}t.call(Ce,n)},this.receive=he,Ze=function(e){Ce._debug("Received",e);for(var n,t=0;t<e.length;++t)n=e[t],he(n)},Ke=function(e,n,t){Ce._debug("handleFailure",e,n,t),t.transport=e;for(var a=0;a<n.length;++a){var s=n[a],r={id:s.id,successful:!1,channel:s.channel,failure:t};switch(t.message=s,s.channel){case"/meta/handshake":Q(r);break;case"/meta/connect":ae(r);break;case"/meta/disconnect":re(r);break;case"/meta/subscribe":r.subscription=s.subscription,ue(r);break;case"/meta/unsubscribe":r.subscription=s.subscription,ge(r);break;default:fe(r);}}},this.registerTransport=function(e,n,t){var a=Re.add(e,n,t);return a&&(this._debug("Registered transport",e),m(n.registered)&&n.registered(e,this)),a},this.unregisterTransport=function(e){var n=Re.remove(e);return null!==n&&(this._debug("Unregistered transport",e),m(n.unregistered)&&n.unregistered()),n},this.unregisterTransports=function(){Re.clear()},this.getTransportTypes=function(){return Re.getTransportTypes()},this.findTransport=function(e){return Re.find(e)},this.getTransportRegistry=function(){return Re},this.configure=function(e){T.call(this,e)},this.init=function(e,n){this.configure(e),this.handshake(n)},this.handshake=function(e,n){if("disconnected"!==De)throw"Illegal state: handshaken";X(e,n)},this.disconnect=function(e,n){if(!_()){m(e)&&(n=e,e=void 0);var t={id:C(),channel:"/meta/disconnect"},a=this._mixin(!1,{},e,t);Ce._putCallback(a.id,n),v("disconnecting"),N([a],!1,"disconnect")}},this.startBatch=function(){M()},this.endBatch=function(){F()},this.batch=function(e,n){var t=Te(e,n);this.startBatch();try{t.method.call(t.scope),this.endBatch()}catch(e){throw this._info("Exception during execution of batch",e),this.endBatch(),e}},this.addTransportListener=function(e,n){if("timeout"!==e)throw"Unsupported event "+e;var t=Ae[e];t||(Ae[e]=t=[]),t.push(n)},this.removeTransportListener=function(e,n){var t=Ae[e];if(t){var a=t.indexOf(n);if(0<=a)return t.splice(a,1),!0}return!1},this._getTransportListeners=function(e){return Ae[e]},this.addListener=function(e,n,t){if(2>arguments.length)throw"Illegal arguments number: required 2, got "+arguments.length;if(!r(e))throw"Illegal argument type: channel must be a string";return ye(e,n,t,!0)},this.removeListener=function(e){if(!e||!e.channel||!("id"in e))throw"Invalid argument: expected subscription, not "+e;y(e)},this.clearListeners=function(){Ee={}},this.subscribe=function(e,n,t,a,s){if(2>arguments.length)throw"Illegal arguments number: required 2, got "+arguments.length;if(!p(e))throw"Illegal argument: invalid channel "+e;if(_())throw"Illegal state: disconnected";m(n)&&(s=a,a=t,t=n,n=void 0),m(a)&&(s=a,a=void 0);var i=!be(e),r=ye(e,n,t,!1);if(i){var o={id:C(),channel:"/meta/subscribe",subscription:e},d=this._mixin(!1,{},a,o);Ce._putCallback(d.id,s),j(d)}else m(s)&&Ce.setTimeout(function(){z(s,{id:C(),successful:!0,channel:"/meta/subscribe",subscription:e})},0);return r},this.unsubscribe=function(e,n,t){if(1>arguments.length)throw"Illegal arguments number: required 1, got "+arguments.length;if(_())throw"Illegal state: disconnected";m(n)&&(t=n,n=void 0),this.removeListener(e);var a=e.channel;if(!be(a)){var s={id:C(),channel:"/meta/unsubscribe",subscription:a},i=this._mixin(!1,{},n,s);Ce._putCallback(i.id,t),j(i)}else m(t)&&Ce.setTimeout(function(){z(t,{id:C(),successful:!0,channel:"/meta/unsubscribe",subscription:a})},0)},this.resubscribe=function(e,n){return k(e),e?this.subscribe(e.channel,e.scope,e.callback,n):void 0},this.clearSubscriptions=function(){x()},this.publish=function(e,n,t,a){if(1>arguments.length)throw"Illegal arguments number: required 1, got "+arguments.length;if(!p(e))throw"Illegal argument: invalid channel "+e;if(/^\/meta\//.test(e))throw"Illegal argument: cannot publish to meta channels";if(_())throw"Illegal state: disconnected";m(n)?(a=n,n={},t=void 0):m(t)&&(a=t,t=void 0);var s={id:C(),channel:e,data:n},i=this._mixin(!1,{},t,s);Ce._putCallback(i.id,a),j(i)},this.publishBinary=function(e,n,t,a,s){m(n)?(s=n,n=new ArrayBuffer(0),t=!0,a=void 0):m(t)?(s=t,t=!0,a=void 0):m(a)&&(s=a,a=void 0);var i={meta:a,data:n,last:t};this.publish(e,i,{ext:{binary:{}}},s)},this.remoteCall=function(e,n,t,a,s){if(1>arguments.length)throw"Illegal arguments number: required 1, got "+arguments.length;if(!r(e))throw"Illegal argument type: target must be a string";if(_())throw"Illegal state: disconnected";if(m(n)?(s=n,n={},t=Je.maxNetworkDelay,a=void 0):m(t)?(s=t,t=Je.maxNetworkDelay,a=void 0):m(a)&&(s=a,a=void 0),"number"!=typeof t)throw"Illegal argument type: timeout must be a number";e.match(/^\//)||(e="/"+e);var i="/service"+e;if(!p(i))throw"Illegal argument: invalid target "+e;var o={id:C(),channel:i,data:n},d=this._mixin(!1,{},a,o),u={callback:s};0<t&&(u.timeout=Ce.setTimeout(function(){Ce._debug("Timing out remote call",d,"after",t,"ms"),pe({id:d.id,error:"406::timeout",successful:!1,failure:{message:d,reason:"Remote Call Timeout"}})},t),Ce._debug("Scheduled remote call timeout",d,"in",t,"ms")),Be[d.id]=u,j(d)},this.remoteCallBinary=function(e,n,t,a,s,i){m(n)?(i=n,n=new ArrayBuffer(0),t=!0,a=void 0,s=Je.maxNetworkDelay):m(t)?(i=t,t=!0,a=void 0,s=Je.maxNetworkDelay):m(a)?(i=a,a=void 0,s=Je.maxNetworkDelay):m(s)&&(i=s,s=Je.maxNetworkDelay);var r={meta:a,data:n,last:t};this.remoteCall(e,r,s,{ext:{binary:{}}},i)},this.getStatus=function(){return De},this.isDisconnected=_,this.setBackoffIncrement=function(e){Je.backoffIncrement=e},this.getBackoffIncrement=function(){return Je.backoffIncrement},this.getBackoffPeriod=function(){return Me},this.increaseBackoffPeriod=function(){return A()},this.resetBackoffPeriod=function(){E()},this.setLogLevel=function(e){Je.logLevel=e},this.registerExtension=function(e,n){if(2>arguments.length)throw"Illegal arguments number: required 2, got "+arguments.length;if(!r(e))throw"Illegal argument type: extension name must be a string";for(var t,a=!1,s=0;s<Fe.length;++s)if(t=Fe[s],t.name===e){a=!0;break}return a?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(Fe.push({name:e,extension:n}),this._debug("Registered extension",e),m(n.registered)&&n.registered(e,this),!0)},this.unregisterExtension=function(e){if(!r(e))throw"Illegal argument type: extension name must be a string";for(var n,t=!1,a=0;a<Fe.length;++a)if(n=Fe[a],n.name===e){Fe.splice(a,1),t=!0,this._debug("Unregistered extension",e);var s=n.extension;m(s.unregistered)&&s.unregistered();break}return t},this.getExtension=function(e){for(var n,t=0;t<Fe.length;++t)if(n=Fe[t],n.name===e)return n.extension;return null},this.getName=function(){return e||"default"},this.getClientId=function(){return we},this.getURL=function(){if(ke){var e=ke.getURL();if(e)return e;if(e=Je.urls[ke.getType()],e)return e}return Je.url},this.getTransport=function(){return ke},this.getConfiguration=function(){return this._mixin(!0,{},Je)},this.getAdvice=function(){return this._mixin(!0,{},He)},this.setTimeout=function(e,n){return _e.setTimeout(function(){try{Ce._debug("Invoking timed function",e),e()}catch(n){Ce._debug("Exception invoking timed function",e,n)}},n)},this.clearTimeout=function(e){_e.clearTimeout(e)},window.WebSocket&&this.registerTransport("websocket",new u),this.registerTransport("long-polling",new o),this.registerTransport("callback-polling",new d)},Transport:i,RequestTransport:r,LongPollingTransport:o,CallbackPollingTransport:d,WebSocketTransport:u,Utils:a,Z85:{encode:function(n){var t=null;if(n instanceof ArrayBuffer?t=n:n.buffer instanceof ArrayBuffer?t=n.buffer:Array.isArray(n)&&(t=new Uint8Array(n).buffer),null==t)throw"Cannot Z85 encode "+n;for(var a,s=t.byteLength,r=s%4,o=4-(0===r?4:r),d=new DataView(t),u="",l=0,g=0;g<s+o;++g)if(a=g>=s,l=256*l+(a?0:d.getUint8(g)),0==(g+1)%4){for(var p=52200625,m=5;0<m;--m){if(!a||m>o){var f=e(l/p)%85;u+=c[f]}p/=85}l=0}return u},decode:function(n){for(var t=n.length%5,a=5-(0===t?5:t),s=0;s<a;++s)n+=c[c.length-1];for(var r,o=n.length,d=new ArrayBuffer(4*o/5-a),u=new DataView(d),g=0,m=0,f=0,h=0;h<o;++h)if(r=n.charCodeAt(m++)-32,g=85*g+l[r],0==m%5){for(var b=16777216;1<=b;)f<u.byteLength&&u.setUint8(f++,e(g/b)%256),b/=256;g=0}return d}}}}),function(e,n){"object"==typeof exports?module.exports=n(require(["cometd/cometd"])):"function"==typeof define&&define.amd?define(["cometd/cometd"],n):e.MyPhoner=n(e.org.cometd)}(window,function(e){function n(){this.elements=[]}var t,a,s,i="{BASEURI}",r="{WSURI}",o=parseInt("{ACWTIME}"),d=parseInt("{AUTOREADYTIME}"),u=!0,c=null,l=null,g="",p="",m=null,f=null,h=new n,b=0,T=null,y=null,k=!1,x=0,v=null,_=function(e){if("undefined"!=typeof e){var n=!1;null!=c&&null!=l&&(n=!0);var t={url:i+e.uri,type:"GET",crossDomain:!0,xhrFields:{withCredentials:n},success:function(n,t,a){console.debug(a.getAllResponseHeaders()),a.getResponseHeader("X-CSRF-HEADER")&&a.getResponseHeader("X-CSRF-TOKEN")&&(c=a.getResponseHeader("X-CSRF-HEADER"),l=a.getResponseHeader("X-CSRF-TOKEN"),console.debug("csrfHeaderName: "+c),console.debug("csrfToken: "+l)),e.callback&&e.callback(n)},error:function(n){console.error(n),e.error&&e.error(n)}};e.includeCredentials&&(t.beforeSend=function(n){n.setRequestHeader("Authorization","Basic "+window.btoa(e.username+":"+e.password))}),$.ajax(t)}},C=function(e){if("undefined"!=typeof e){var n=!1;null!=c&&null!=l&&(n=!0);var t=JSON.stringify(e.json,void 0,2),a={url:i+e.uri,type:"POST",data:t,headers:{"Content-Type":"application/json"},crossDomain:!0,xhrFields:{withCredentials:n},handleAs:"json",beforeSend:function(e){null!=c&&null!=l&&e.setRequestHeader(c,l)},success:function(n){e.callback&&e.callback(n)},error:function(n,t,a){console.error("Error! ("+n.status+") : "+t+" "+a),e.error&&e.error(n,t,a)}};try{$.ajax(a)}catch(n){console.error(n)}}};n.prototype.length=function(){return this.elements.length},n.prototype.peek=function(e){return("undefined"==typeof e||null==e)&&(e=0),0<=e&&e<this.elements.length?this.elements[e]:{uuid:void 0,calling:void 0,recordid:void 0,userdata:void 0,parentuuid:void 0,skill:void 0}},n.prototype.has=function(e){for(var n of this.elements)if(n.uuid==e)return n;return null},n.prototype.replace=function(e,n){for(var t=null,a=0;a<this.elements.length;a++)if(this.elements[a].uuid==e){t=this.elements.splice(a,1)[0];break}t&&(t.uuid=n,this.elements.unshift(t))},n.prototype.setCalling=function(e,n,t,a){for(var s=null,r=0;r<this.elements.length;r++)if(this.elements[r].uuid==e){s=this.elements.splice(r,1)[0];break}s?(n&&0<n.length&&(s.calling=n),"undefined"!=typeof t&&(s.inbound=t),a&&0<a.length&&(s.parentuuid=a)):s={uuid:e,calling:n,inbound:t,parentuuid:a},this.elements.unshift(s)},n.prototype.setUserData=function(e,n,t){for(var a=null,s=0;s<this.elements.length;s++)if(this.elements[s].uuid==e){a=this.elements.splice(s,1)[0];break}a?(n&&0<n.length&&(a.userdata=n),t&&0<t.length&&(a.skill=t)):a={uuid:e,userdata:n,skill:t},this.elements.unshift(a)},n.prototype.setRecordId=function(e,n){for(var t=null,a=0;a<this.elements.length;a++)if(this.elements[a].uuid==e){t=this.elements.splice(a,1)[0];break}t?n&&0<n.length&&(t.recordid=n):t={uuid:e,recordid:n},this.elements.unshift(t)},n.prototype.delete=function(e){for(var n=0;n<this.elements.length;n++)if(this.elements[n].uuid==e)return this.elements.splice(n,1),!0;return!1},n.prototype.clear=function(){this.elements=[]},n.prototype.debug=function(e){if(0<this.elements.length)for(var n=0;n<this.elements.length;n++)console.debug(e+n+"="+JSON.stringify(this.elements[n]));else console.debug(e+"0=NULL")};var S=async function(n){if("function"==typeof n&&(await R({uri:"/api/v2/me",includeCredentials:!0,username:t,password:a}),f=n,u&&null!=m&&(m.unregisterTransports(),m.clearSubscriptions(),m.clearListeners(),m.disconnect(),m=null),null==m)){m=new e.CometD("MyPhoner"),m.unregisterTransports(),/^ws/.test(r)&&window.WebSocket?m.registerTransport("websocket",new e.WebSocketTransport):(r=r.replace(/^ws/,"http"),m.registerTransport("long-polling",new e.LongPollingTransport)),m.addListener("/meta/handshake",j),m.addListener("/meta/connect",w),m.addListener("/meta/disconnect",L);var s={};null!=c&&null!=l&&(s[c]=l),m.configure({url:r+"/api/v2/notifications",logLevel:"debug",requestHeaders:s}),m.handshake()}},R=async function(e){var n=e;return new Promise(function(e){n.callback=function(){e(0)},n.error=function(){e(-1)},_(n)})},D=!1,U=null,w=function(e){if(m.isDisconnected())return void console.log("############ Cometd is Disconnected ##############");var n=D;D=e.successful,!n&&D?(console.debug("Cometd connected."),B()):n&&!D&&(console.debug("Cometd disconnected..."),"function"==typeof f&&f("Logout")),console.log("Cometd connected = "+D+", wasConnected = "+n)},L=function(e){e.successful&&(D=!1,console.debug("Cometd disconnected."))},I=function(e,n){if("undefined"!=typeof e)return e;return"undefined"==typeof n?void 0:n},N=function(e){console.debug("Cometd message received:\n"+JSON.stringify(e,null,2));var n=e.data;if("DeviceStateChangeMessage"==n.messageType){if(n.devices&&0<n.devices.length){var t=MyPhoner.GetLoginInfo();if(t&&t.extension){for(var a=null,s=0;s<n.devices.length;s++)if(n.devices[s].phoneNumber==t.extension){a=n.devices[s];break}if(a&&"undefined"!=typeof a.userState){var r="";switch("undefined"==typeof a.userState.workMode?"undefined"!=typeof a.userState.state&&(r=a.userState.state):r=a.userState.workMode,r){case"AfterCallWork":b=1,1!=T&&(T=1,"function"==typeof f&&f("NotReady 1"));break;case"AuxWork":null!=v&&(clearTimeout(v),v=null),b=0,0!=T&&(T=0,"function"==typeof f&&f("NotReady"));break;default:"Ready"==a.userState.state?(null!=v&&(clearTimeout(v),v=null),b=-1,-1!=T&&(T=-1,"function"==typeof f&&f("Ready"))):(null!=v&&(clearTimeout(v),v=null),b=2,2!=T&&(T=2,"function"==typeof f&&f("NotReady 2")));}}}}}else if("CallStateChangeMessage"==n.messageType&&n.notificationType){var u=n.call;if(u)if("CallRecordingStateChange"==n.notificationType)h.setRecordId(u.callUuid,u.callUuid),"function"==typeof f&&f("Recording "+u.callUuid);else if("AttachedDataChanged"==n.notificationType)u.userData&&"undefined"!=typeof u.userData&&(h.setUserData(u.callUuid,I(u.userData.userData),I(u.userData.pro_group,u.userData.RTargetObjectSelected)),"function"==typeof f&&u.userData.userData&&f("UserData "+u.userData.userData));else if("ParticipantsUpdated"==n.notificationType)"undefined"!=typeof n.previousCallId&&h.replace(n.previousCallId,u.callUuid),"undefined"!=typeof u.participants&&1<u.participants.length&&"function"==typeof f&&f("Conference "+u.participants.length);else if("StatusChange"==n.notificationType)switch(u.state){case"Released":if(h.delete(u.callUuid)&&(k=!1,"function"==typeof f))if(0<h.length())f("OpDisconnect "+u.callUuid);else{if(d>o){x=0;var c=o/2;1>c&&(c=1),v=setTimeout(E,1e3*c)}f("Disconnect "+u.callUuid)}break;case"Dialing":h.setCalling(u.callUuid,u.dnis,!1),y&&0<y.length&&(C({uri:"/api/v2/me/calls/"+u.callUuid,json:{operationName:"AttachUserData",userData:{userData:y}}}),y=null),u.userData&&"undefined"!=typeof u.userData&&(h.setUserData(u.callUuid,I(u.userData.userData),I(u.userData.pro_group,u.userData.RTargetObjectSelected)),"function"==typeof f&&u.userData.userData&&f("UserData "+u.userData.userData)),"function"==typeof f&&f("Dial "+u.dnis);break;case"Ringing":h.setCalling(u.callUuid,u.ani,!0),"undefined"==typeof u.parentCallPath?u.userData&&"undefined"!=typeof u.userData&&"undefined"!=typeof u.userData.RTargetPlaceSelected&&MyPhoner.GetLoginInfo()&&u.userData.RTargetPlaceSelected!=MyPhoner.GetLoginInfo().extension?h.setCalling(u.callUuid,u.ani,!0,u.callUuid):h.setCalling(u.callUuid,u.ani,!0):h.setCalling(u.callUuid,u.ani,!0,u.parentCallPath.replace(/^\/calls\//,"")),y&&0<y.length&&(C({uri:"/api/v2/me/calls/"+u.callUuid,json:{operationName:"AttachUserData",userData:{userData:y}}}),y=null),u.userData&&"undefined"!=typeof u.userData&&(h.setUserData(u.callUuid,I(u.userData.userData),I(u.userData.pro_group,u.userData.RTargetObjectSelected)),"function"==typeof f&&u.userData.userData&&f("UserData "+u.userData.userData)),"function"==typeof f&&f("Ring "+u.ani);break;case"Established":var l=h.has(u.callUuid);u.userData&&"undefined"!=typeof u.userData&&(h.setUserData(u.callUuid,I(u.userData.userData),I(u.userData.pro_group,u.userData.RTargetObjectSelected)),"function"==typeof f&&u.userData.userData&&f("UserData "+u.userData.userData)),l&&"function"==typeof f&&(l.inbound?f("Answer"):f("Connected"));}}},j=function(e){!0===e.successful&&(U&&(console.debug("unsubscribing: "+U),m.unsubscribe(U)),console.debug("Subscribing to channels..."),U=m.subscribe("/v2/me/*",N))},E=function(){var e=o/2;1>e&&(e=1),x+=e,x<d?(0<o&&MyPhoner.NotReady(1),v=setTimeout(E,1e3*e)):("function"==typeof f&&f("AutoReady"),v=null,MyPhoner.Ready())},A=function(){return D&&_({uri:"/api/v2/me/calls",callback:M,error:function(e){console.error(e)}}),h.peek()},M=function(e){var n=[];if(e.paths)for(var t in e.paths)if("string"==typeof e.paths[t]){t=e.paths[t].replace(/^\/calls\//,"");var a=h.has(t);a&&n.push(a)}else console.error(e.paths);"function"==typeof f&&f(n)},q=function(e){return D?(e&&(MyPhonerHost&&(0==MyPhonerHost.baseUri.length&&(MyPhonerHost.baseUri=location.origin),r=i=MyPhonerHost.baseUri,MyPhonerHost.wsUri&&0<MyPhonerHost.wsUri.length&&(r=MyPhonerHost.wsUri),d=MyPhonerHost.autoReadyTime,o=MyPhonerHost.acwTime,u=MyPhonerHost.cometdHardMode),_({uri:"/api/v2/me/devices?fields=*",callback:function(e){console.debug(JSON.stringify(e))},error:function(e){console.error(e)}})),0<h.length()?$.extend({agent:t,extension:s},h.peek()):{agent:t,extension:s,uuid:"",userdata:""}):null},F=function(){return b},H=function(e,n,c,l,g,p){MyPhonerHost&&(0==MyPhonerHost.baseUri.length&&(MyPhonerHost.baseUri=location.origin),r=i=MyPhonerHost.baseUri,MyPhonerHost.wsUri&&0<MyPhonerHost.wsUri.length&&(r=MyPhonerHost.wsUri),d=MyPhonerHost.autoReadyTime,o=MyPhonerHost.acwTime,u=MyPhonerHost.cometdHardMode),t=e,a="string"==typeof n?n:"",s=c,"function"==typeof p&&(f=p),_({uri:"/api/v2/me",includeCredentials:!0,username:t,password:a,callback:O,error:function(e){console.error(JSON.stringify(e)),"function"==typeof f&&f("Logout")}})},O=function(e){T=null,g=e.user.id,console.debug(JSON.stringify(e)),"function"==typeof f?S(f):_({uri:"/api/v2/users/"+g+"?subresources=devices,calls",callback:P})},B=function(){C({uri:"/api/v2/me",json:{operationName:"StartContactCenterSession",channels:["voice"],loginCode:t,place:s},callback:function(e){console.debug(JSON.stringify(e)),_({uri:"/api/v2/me/devices",includeCredentials:!0,username:t,password:a,callback:function(e){console.debug(JSON.stringify(e)),"undefined"==typeof e.paths||0==e.paths.length?_({uri:"/api/v2/users/"+g+"?subresources=devices,calls",callback:P,error:function(e){console.error(JSON.stringify(e)),"function"==typeof f&&f("Logout")}}):(p=e.paths[0],_({uri:"/api/v2/users/"+g+"?subresources=devices,calls",callback:P,error:function(e){console.error(JSON.stringify(e)),"function"==typeof f&&f("Logout")}}))},error:function(e){console.warn(JSON.stringify(e)),_({uri:"/api/v2/users/"+g+"?subresources=devices,calls",callback:P,error:function(e){console.error(JSON.stringify(e)),"function"==typeof f&&f("Logout")}})}})},error:function(e){if(console.error(JSON.stringify(e)),"undefined"!=typeof e.responseText){var n=JSON.parse(e.responseText);"function"==typeof f&&f("Logout "+n.statusMessage)}else"function"==typeof f&&f("Logout")}})},P=function(e){if(console.debug(JSON.stringify(e)),"undefined"!=typeof e.user.calls&&0<e.user.calls.length)for(var n in h.clear(),e.user.calls){var t=e.user.calls[n];h.setCalling(t.callUuid,t.ani),h.setRecordId(t.callUuid,t.callUuid),t.userData&&"undefined"!=typeof t.userData&&h.setUserData(t.callUuid,I(t.userData.userData),I(t.userData.pro_group,t.userData.RTargetObjectSelected))}"undefined"!=typeof e.user.devices&&0<e.user.devices.length&&"undefined"!=typeof e.user.devices[0].paths&&0<e.user.devices[0].paths.length?(p=e.user.devices[0].paths[0],"function"==typeof f&&f("Login")):p&&0<p.length?(console.debug("trying success!"),"function"==typeof f&&f("Login")):"function"==typeof f&&f("Logout")},W=function(){D&&C({uri:"/api/v2/me",json:{operationName:"EndContactCenterSession"},callback:X})},X=function(){u&&(null!=m&&(m.unregisterTransports(),m.clearSubscriptions(),m.clearListeners(),m.disconnect(),m=null),"function"==typeof f&&(f("Logout"),f=null),D=!1,U=null,c=null,l=null)},G=function(e){("0"==e.statusCode||0==e.statusCode)&&"function"==typeof f&&(b=-1,T=-1,f("Ready"))},z=function(e){("0"==e.statusCode||0==e.statusCode)&&"function"==typeof f&&(T=null,f("NotReady"))},J=function(){0>=h.length()||D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"Answer"}})},Z=function(){0>=h.length()||D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"CompleteTransfer"},callback:K})},K=function(){k=!1},V=function(){0>=h.length()||D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"CompleteConference"},callback:Y})},Y=function(){k=!1},Q=function(){0>=h.length()||D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"Hold"}})},ee=function(){0>=h.length()||D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"Retrieve"}})},ne=function(){0>=h.length()||D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"Hangup"}})},te=function(e,n){0<h.length()||/^\d+$/.test(e)&&19>e.length&&D&&(y=n,C({uri:"/api/v2/me"+p+"/calls",json:{operationName:"Dial",destination:{phoneNumber:e}},callback:ae,error:function(e){console.error(JSON.stringify(e))}}))},ae=function(e){console.debug(JSON.stringify(e))},se=function(e,n){if(/^\d+$/.test(e)&&19>e.length&&D){if(y=n,k=!1,0<h.length())return void C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"InitiateConference",destination:{phoneNumber:e}},callback:ie});C({uri:"/api/v2/me"+p+"/calls",json:{operationName:"Dial",destination:{phoneNumber:e}}})}},ie=function(e){k=!("0"!=e.statusCode&&0!=e.statusCode),console.debug("consulCall = "+k)},re=function(e){0>=h.length()||/^\d+$/.test(e)&&19>e.length&&D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"SingleStepTransfer",destination:{phoneNumber:e}}})},oe=function(e){0>=h.length()||/^\d+$/.test(e)&&19>e.length&&D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"SingleStepConference",destination:{phoneNumber:e}}})},de=function(){return k},ue=function(e){0>=h.length()||/^\d+$/.test(e)&&19>e.length&&D&&C({uri:"/api/v2/me/calls/"+h.peek().uuid,json:{operationName:"Reject"}})},ce=function(e){if(console.log(e),e.paths)for(var n in e.paths)if("string"==typeof e.paths[n]){var t=e.paths[n].replace(/^\/users\//,"");_({uri:"/api/v2/users/"+t+"??subresources=devices,calls",callback:le,error:function(e){console.error(e)}})}},le=function(e){console.log(e)};return{Login:H,Ready:function(){C({uri:"/api/v2/me/channels/voice",json:{operationName:"Ready"},callback:G})},NotReady:function(e){var n="AuxWork";1===e?n="AfterCallWork":2===e?n="NotReady":void 0;C({uri:"/api/v2/me/channels/voice",json:{operationName:n},callback:z})},Dial:te,MakeCall:se,GetCallInfo:A,Hangup:ne,Answer:J,Reject:ue,Logout:W,Hold:Q,Unhold:ee,Conference:oe,Transfer:re,ConferenceCall:V,TransferCall:Z,GetConsulCall:de,GetEvents:S,GetLoginInfo:q,GetReadyStatus:F,Monitor:function(){},Intrude:function(){},GetUsers:function(){_({uri:"/api/v2/users",callback:ce,error:function(e){console.error(e)}})}}})})();
//# sourceMappingURL=MyPhoner.js.map
